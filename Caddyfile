# Caddyfile - automatic TLS via Let's Encrypt
# Serves https://chm.proxzima.dev and routes API requests to backend services
chm.proxzima.dev {
    # Health check endpoint
    route /health {
        respond "OK" 200
    }

    # Route GitHub API requests
    route /api/github/* {
        uri strip_prefix /api/github
        reverse_proxy backend-github:5000 {
            health_uri /health
            health_interval 30s
            health_timeout 10s
        }
    }

    # Route Azure DevOps API requests  
    route /api/azuredevops/* {
        uri strip_prefix /api/azuredevops
        reverse_proxy backend-azuredevops:5000 {
            health_uri /health
            health_interval 30s
            health_timeout 10s
        }
    }

    # Route Hub API requests (aggregated contributions)
    route /api/hub/* {
        uri strip_prefix /api/hub
        reverse_proxy backend-hub:5000 {
            health_uri /health
            health_interval 30s
            health_timeout 10s
        }
    }

    # Default API route to Hub (backward compatibility)
    route /api/* {
        uri strip_prefix /api
        reverse_proxy backend-hub:5000 {
            health_uri /health
            health_interval 30s
            health_timeout 10s
        }
    }

    # Everything else goes to frontend
    reverse_proxy frontend:3000 {
        health_uri /api/health
        health_interval 30s
        health_timeout 10s
    }

    # Security headers
    header {
        # Enable HSTS
        Strict-Transport-Security max-age=31536000;
        # Prevent MIME sniffing
        X-Content-Type-Options nosniff
        # Enable XSS protection
        X-Frame-Options DENY
        # Referrer policy
        Referrer-Policy strict-origin-when-cross-origin
    }

    # Enable compression
    encode gzip

    # Logging
    log {
        output file /var/log/caddy/access.log
        format json
    }
}
